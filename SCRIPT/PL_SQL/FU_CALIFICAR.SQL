CREATE OR REPLACE FUNCTION FU_CALIFICAR_RV (P_IDREPVENTAS IN NUMBER) 
RETURN NUMBER 
AS 
P_CONTADOR NUMBER := 0;
P_CALIFICACION NUMBER := 0;
CURSOR C_CALIFICACIONES IS SELECT CALIFICACION 
                                FROM HISTORICOCRV HCRV, 
                                REPRESENTANTEVENTAS RV, 
                                CLIENTE C,
                                VENTA V,
                                CALIFICACIONVENTA CV
                           WHERE RV.IDREPRESENTANTEVENTAS=P_IDREPVENTAS AND
                                 HCRV.IDREPRESENTANTEVENTAS=RV.IDREPRESENTANTEVENTAS AND
                                 HCRV.IDCLIENTE=C.IDCLIENTE AND
                                 C.IDCLIENTE=V.IDCLIENTE AND
                                 V.IDVENTA=CV.IDVENTA AND
                                 (V.FECHAVENTA BETWEEN HCRV.FECHAINICIO AND NVL(HCRV.FECHAFIN,SYSDATE)) AND
                                 (EXTRACT(MONTH FROM SYSDATE)-1)=EXTRACT(MONTH FROM V.FECHAVENTA);
BEGIN
    FOR RC_CALIFICACIONES IN C_CALIFICACIONES LOOP
        /*DBMS_OUTPUT.PUT_LINE(RC_CALIFICACIONES.CALIFICACION);*/
        P_CALIFICACION := P_CALIFICACION + RC_CALIFICACIONES.CALIFICACION;
        P_CONTADOR := P_CONTADOR + 1;
    END LOOP;
    IF P_CONTADOR=0 THEN
        RETURN 0;
    ELSE
        DBMS_OUTPUT.PUT_LINE(P_CALIFICACION||' '||P_CONTADOR||' '||P_CALIFICACION/P_CONTADOR);
        RETURN P_CALIFICACION/P_CONTADOR;
    END IF;
END FU_CALIFICAR_RV;